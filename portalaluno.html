<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Portal do Aluno – Editora Crás</title>
  <meta name="description" content="Acompanhe o próximo feedback, envie exercícios e acesse conteúdos gravados.">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Editora Crás">
  <meta property="og:title" content="Portal do Aluno – Editora Crás">
  <meta property="og:description" content="Envio de exercícios e link do feedback semanal.">
  <meta property="og:image" content="assets/og-index.jpg">
  <link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" sizes="180x180">
  <link rel="shortcut icon" href="assets/favicon.ico">
  <meta name="theme-color" content="#0286ff">
  <link rel="stylesheet" href="style.css?v=3">

  <style>
    /* Topbar full width */
    .topbar{
      width:100vw; margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw);
      background:#e6b200; color:#000; font-weight:800; text-align:center; padding:12px 0;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.08);
    }
    .curso-logo{width:200px;max-width:60vw;height:auto;display:block;margin:10px auto 6px}
    .dias-restantes{font-weight:800;margin:8px 0 6px;text-align:center}
    .dias-danger{color:#d93025}

    /* Cartões brancos */
    .box-card{max-width:900px;margin:14px auto;background:#fff;border:1px solid #f2e3a6;
      border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .box-card h3{margin:0 0 14px; text-align:center}
    .box-card p{margin:6px 0;line-height:1.5; text-align:center}

    .btn-cta{display:block;width:100%;max-width:520px;margin:18px auto 6px;padding:12px 18px;border:none;border-radius:12px;background:#e6b200;color:#111;font-weight:800;cursor:pointer}
    .btn-cta:disabled{opacity:.6;cursor:not-allowed}

    .hidden{display:none!important}
    #overlay{display:none;position:fixed;inset:0;width:100svw;height:100svh;background:rgba(255,255,255,.85);z-index:9999;place-items:center}
    #overlay .loader-text{font-size:18px;color:#111}

    /* Links úteis (sem cartão branco) */
    .links-uteis{max-width:900px;margin:22px auto 10px;}
    .links-uteis h3{margin:8px 0 10px;text-align:center}

    /* Botão sair compacto */
    .btn-exit{
      display:inline-block; margin:12px auto; padding:10px 18px; background:#e53935; color:#fff;
      border:none; border-radius:10px; font-weight:800; cursor:pointer;
    }
    .exit-wrap{ text-align:center; }
  </style>
</head>
<body>
  <div class="topbar">[aluno]</div>

  <main class="page-center" style="--center-offset: -40px;">
    <img id="cursoLogo" class="curso-logo" alt="Curso" style="display:none">

    <div id="diasRestantes" class="dias-restantes">Carregando...</div>

    <!-- Próximo feedback -->
    <section class="box-card" id="cardFeedback">
      <h3>Próximo feedback:</h3>
      <p id="fbWhen" style="font-weight:800">—</p>
      <p>Professor: <strong id="fbProfessor">—</strong></p>
      <p><a id="fbLink" href="#" target="_blank" rel="noopener">[link da aula]</a></p>
      <p>Senha: <strong id="fbSenha">—</strong></p>
      <p id="fbInfo" style="margin-top:10px;color:#333">—</p>
    </section>

    <!-- Última aula gravada (agora cartão branco) -->
    <section class="box-card" id="cardGravada">
      <h3 style="margin-top:0;">Última aula gravada:</h3>
      <p class="hint">Aproveite para baixar pois ela expira.</p>
      <p><a id="ultimaGravada" href="#" target="_blank" rel="noopener">[link]</a></p>
    </section>

    <!-- Botão de envio vem depois -->
    <button id="btnAbrirEnvio" class="btn-cta" type="button" onclick="abrirEnvio()">
      Envie os exercícios para feedback
    </button>

    <!-- Links úteis simples -->
    <section class="links-uteis">
      <h3>Links úteis</h3>
      <!-- Coloque seus links aqui depois (exemplos comentados)
      <p style="text-align:center"><a href="#" target="_blank">Regulamento do feedback</a></p>
      -->
    </section>

    <!-- Botão sair compacto -->
    <div class="exit-wrap">
      <button class="btn-exit" type="button" id="btnSair">sair</button>
    </div>

    <!-- Área de envio -->
    <section id="envio" class="hidden">
      <div class="box-card">
        <h3>Envio de exercício para feedback</h3>
        <div class="hint" style="text-align:center">*No máximo 3 artes por semana. Envie apenas no dia do feedback.</div>

        <label class="title-label">Selecione o módulo do exercício:</label>
        <select id="selModulo" class="input-like" disabled>
          <option value="">Carregando módulos…</option>
        </select>

        <label class="title-label">Selecione a aula do exercício:</label>
        <select id="selAula" class="input-like" disabled>
          <option value="">Selecione o módulo primeiro</option>
        </select>

        <label class="title-label">Envie a arte:</label>
        <div id="filesWrap" class="row">
          <input type="file" class="fileItem" accept="image/*">
          <div class="thumb-hint">Formatos de imagem (JPG/PNG). Até 3 envios.</div>
        </div>

        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button id="btnAddImagem" class="btn-sec" type="button">Quero enviar outra imagem</button>
          <button id="btnResetar" class="btn-sec" type="button">Resetar</button>
        </div>

        <label class="title-label">[Descrição:]</label>
        <textarea id="descricao" rows="6" placeholder="Conte sobre suas dificuldades/pensamentos ao fazer esses desenhos."></textarea>

        <button id="btnEnviar" class="btn-cta" type="button">Enviar</button>
      </div>
    </section>

    <section id="sucesso" class="hidden">
      <div class="box-card">
        <h3>✅ Enviado!</h3>
        <p style="text-align:center">Pronto! Logo menos seu desenho será avaliado!</p>
        <div class="exit-wrap"><button id="btnVoltarMenu" class="btn-sec" type="button">Menu</button></div>
      </div>
    </section>
  </main>

  <div id="overlay"><div class="loader"><div class="loader-text">Enviando…</div></div></div>

  <footer class="site-footer">
    <div class="footer-inner">
      <strong>Editora Crás • </strong>
      <a href="mailto:contato@editoracras.com">Suporte</a>
      <small>© 2025. Todos os direitos reservados.</small>
    </div>
  </footer>

  <script>
    const BUILD_VERSION = "4";
    const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";
    const MAX_FILES = 3;

    let sessao = null;
    let bootstrap = null;

    const qs  = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    function setTopbarName(nome){ qs(".topbar").textContent = `[${nome || "aluno"}]`; }
    function setLoading(state){ qs("#overlay").style.display = state ? "grid" : "none"; const b=qs("#btnEnviar"); if(b) b.disabled = state; }
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    // util: normaliza hora (20:00) mesmo se vier Date "1899..."
    function normalizeHora(h){
      if (!h) return "—";
      if (/^\d{1,2}:\d{2}$/.test(h)) return h;
      const d = new Date(h);
      if (!isNaN(d.getTime())){
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${hh}:${mm}`;
      }
      return String(h);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try { sessao = JSON.parse(localStorage.getItem("sessao_portal") || "null"); } catch {}
      const params = new URLSearchParams(location.search);
      if (!sessao) sessao = { email: params.get("email"), curso: params.get("curso") };

      if (!sessao || !validEmail(sessao.email) || !sessao.curso) {
        alert("Faça login novamente.");
        location.href = "index.html";
        return;
      }

      await carregarBootstrap(sessao.curso, sessao.email);

      // Binds
      qs("#btnAbrirEnvio").addEventListener("click", abrirEnvio);
      qs("#btnAddImagem").addEventListener("click", addFileInput);
      qs("#btnResetar").addEventListener("click", resetFiles);
      qs("#btnEnviar").addEventListener("click", enviarExercicio);
      qs("#btnVoltarMenu").addEventListener("click", () => { hide(qs("#sucesso")); show(qs("#dashboard")); window.scrollTo({ top: 0, behavior: "smooth" }); });
      qs("#btnSair").addEventListener("click", () => { localStorage.removeItem("sessao_portal"); location.href = "index.html"; });
    });

    async function carregarBootstrap(curso, email){
      try{
        const resp = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(curso)}&email=${encodeURIComponent(email)}`, { cache:"no-store" });
        bootstrap = await resp.json();

        if (!bootstrap || bootstrap.allowed !== true) { location.href = "index.html"; return; }

        setTopbarName(bootstrap.nome);

        const logoEl = qs("#cursoLogo");
        if (bootstrap.logoUrl) { logoEl.src = bootstrap.logoUrl; logoEl.style.display = "block"; }

        // Dias restantes + cupom
        const dr = Number(bootstrap.diasRestantes || 0);
        qs("#diasRestantes").textContent = dr > 0 ? `[${dr}] dias restantes de acesso ao curso` : `Seu acesso está expirado.`;
        if (dr <= 30 && bootstrap.desconto && bootstrap.desconto.cupom) {
          const cup = bootstrap.desconto;
          // (A caixa do cupom ficou removida no layout novo – se quiser reexibir, basta recolocar aqui)
        }

        // Monta bloco do próximo feedback
        const fb = bootstrap.feedback || {};
        const dataStr = (fb.titulo || "").trim(); // use o Título como data (ex.: 30/10)
        const diaStr  = (fb.dia || "").trim();     // ex.: Quinta-feira
        const horaStr = normalizeHora(fb.hora || "");
        const whenOut = (dataStr || diaStr || horaStr)
          ? `${dataStr ? dataStr + " - " : ""}${diaStr ? diaStr + " " : ""}${horaStr ? "às " + horaStr + " horas." : ""}`.trim()
          : "—";
        qs("#fbWhen").textContent = whenOut;
        qs("#fbProfessor").textContent = bootstrap.professorNome || "—";
        qs("#fbSenha").textContent = fb.senha || "—";
        qs("#fbInfo").textContent  = fb.info  || "—";

        const linkEl = qs("#fbLink");
        if (fb.link && /^https?:\/\//i.test(fb.link)) { linkEl.href = fb.link; linkEl.textContent = fb.link; }
        else { linkEl.removeAttribute("href"); linkEl.textContent = fb.link || "—"; }

        const ag = String(fb.aulaGravada || "");
        const grav = qs("#ultimaGravada");
        grav.textContent = ag || "—";
        if (ag && /^https?:\/\//i.test(ag)) grav.href = ag; else grav.removeAttribute("href");

      } catch(e){
        alert("Erro ao carregar a página.");
        location.href = "index.html";
      }
    }

    // Abrir envio
    async function abrirEnvio(){
      hide(qs("#cardFeedback").parentElement); // esconde tudo acima (dias + cards)
      hide(qs("#cardGravada").parentElement);
      hide(qs(".links-uteis"));
      hide(qs(".exit-wrap"));
      await carregarModulos().catch(()=>{});
      show(qs("#envio"));
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Módulos/Aulas
    async function carregarModulos(){
      const sel = qs("#selModulo");
      const selA = qs("#selAula");
      sel.disabled = true; sel.innerHTML = `<option value="">Carregando módulos…</option>`;
      selA.disabled = true; selA.innerHTML = `<option value="">Selecione o módulo primeiro</option>`;
      try{
        const resp = await fetch(`${API_URL}?action=listModules&curso=${encodeURIComponent(sessao.curso)}`, { cache:"no-store" });
        const data = await resp.json();
        const mods = Array.isArray(data.modulos) ? data.modulos : [];
        sel.innerHTML = `<option value="">Selecione seu curso / módulo</option>`;
        mods.forEach(m => { const op = document.createElement("option"); op.value = m; op.textContent = m; sel.appendChild(op); });
        sel.disabled = false;
        sel.onchange = carregarAulas;
      }catch(e){
        sel.innerHTML = `<option value="">Erro ao carregar módulos</option>`;
      }
    }

    async function carregarAulas(){
      const modulo = qs("#selModulo").value;
      const sel = qs("#selAula");
      sel.disabled = true; sel.innerHTML = `<option value="">Carregando aulas…</option>`;
      if (!modulo) { sel.innerHTML = `<option value="">Selecione o módulo primeiro</option>`; return; }
      try{
        const resp = await fetch(`${API_URL}?action=listLessons&curso=${encodeURIComponent(sessao.curso)}&modulo=${encodeURIComponent(modulo)}`, { cache:"no-store" });
        const data = await resp.json();
        const aulas = Array.isArray(data.aulas) ? data.aulas : [];
        sel.innerHTML = `<option value="">Selecione a aula</option>`;
        aulas.forEach(a => { const op = document.createElement("option"); op.value = a; op.textContent = a; sel.appendChild(op); });
        sel.disabled = false;
      }catch(e){
        sel.innerHTML = `<option value="">Erro ao carregar aulas</option>`;
      }
    }

    // Upload
    function addFileInput(){
      const wrap = qs("#filesWrap");
      const count = wrap.querySelectorAll("input[type='file']").length;
      if (count >= MAX_FILES) return alert(`Você pode enviar no máximo ${MAX_FILES} imagens.`);
      const input = document.createElement("input");
      input.type = "file"; input.accept = "image/*"; input.className = "fileItem";
      wrap.insertBefore(input, wrap.querySelector(".thumb-hint"));
    }
    function resetFiles(){
      qs("#filesWrap").innerHTML = `<input type="file" class="fileItem" accept="image/*"><div class="thumb-hint">Formatos de imagem (JPG/PNG). Até 3 envios.</div>`;
    }
    function readFileAsBase64(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => { const res = String(fr.result || ""); const b64 = res.split(",")[1] || ""; resolve({ name: file.name, type: file.type || "image/jpeg", content: b64 }); };
        fr.onerror = () => reject(fr.error || new Error("erro no reader"));
        fr.readAsDataURL(file);
      });
    }
    async function enviarExercicio(){
      const modulo = (qs("#selModulo").value || "").trim();
      const aula   = (qs("#selAula").value   || "").trim();
      const desc   = (qs("#descricao").value || "").trim();
      if (!modulo) return alert("Selecione o módulo.");
      if (!aula)   return alert("Selecione a aula.");

      const chosen = qsa("#filesWrap input[type='file']").map(i => i.files && i.files[0]).filter(Boolean);
      if (!chosen.length) return alert("Envie pelo menos uma imagem.");
      if (chosen.length > MAX_FILES) return alert(`Máximo de ${MAX_FILES} imagens.`);

      setLoading(true);
      try{
        const files = [];
        for (const f of chosen) files.push(await readFileAsBase64(f));
        const body = { action:"uploadExercise", curso:sessao.curso, email:sessao.email, nome:bootstrap?.nome || "", modulo, aula, descricao: desc, files };
        const resp = await fetch(API_URL, { method:"POST", body: JSON.stringify(body) });
        if (!resp.ok){ const txt = await resp.text(); throw new Error(`HTTP ${resp.status} – ${txt.slice(0,200)}`); }
        let data = null; try { data = await resp.json(); } catch {}
        if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || "Falha no envio");
        hide(qs("#envio")); show(qs("#sucesso")); window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (e){
        alert("Erro ao enviar. Detalhe: " + e.message);
      } finally { setLoading(false); }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Portal do Aluno ‚Äì Editora Cr√°s</title>
  <meta name="description" content="Acompanhe o pr√≥ximo feedback, envie exerc√≠cios e acesse conte√∫dos gravados.">
  <link rel="icon" type="image/png" href="assets/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.png" sizes="180x180">
  <link rel="shortcut icon" href="assets/favicon.ico">
  <meta name="theme-color" content="#0286ff">
  <link rel="stylesheet" href="style.css?v=7">

  <style>
    .topbar{
      width:100vw;margin-left:calc(50% - 50vw);margin-right:calc(50% - 50vw);
      background:#e6b200;color:#000;font-weight:800;text-align:center;
      padding:12px 0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
    }
    .curso-logo{width:200px;max-width:60vw;height:auto;display:block;margin:10px auto 6px}
    .dias-restantes{font-weight:800;margin:8px 0 6px;text-align:center}
    .dias-danger{color:#d93025}

    .card,.box-feedback{
      max-width:900px;margin:14px auto;background:#fff;border:1px solid #f2e3a6;
      border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);text-align:center;
    }

    label{display:block;text-align:left;font-weight:700;margin-top:10px;margin-bottom:4px}
    select,textarea,input[type="file"]{width:100%;max-width:100%;box-sizing:border-box}
    textarea{min-height:120px;border-radius:10px;border:1px solid #ccc;padding:10px}

    .btn-cta{
      display:block;width:100%;max-width:900px;margin:16px auto 10px;padding:16px 18px;
      border:none;border-radius:18px;background:#e6b200;color:#111;font-weight:800;cursor:pointer;
    }
    .flex-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .btn-sec{background:#ddd;color:#111;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-exit{display:inline-block;margin:8px auto 24px;padding:10px 18px;background:#e53935;color:#fff;border:none;border-radius:12px;font-weight:800;cursor:pointer}
    .btn-back{background:#ddd;color:#111;border:none;border-radius:12px;padding:10px 18px;font-weight:800;cursor:pointer}
    .hidden{display:none!important}

    /* Selects */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #fff url('data:image/svg+xml;utf8,<svg fill="%23000" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,8 10,13 15,8"/></svg>') no-repeat right 12px center;
      background-size: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px 36px 10px 12px;
      font-size: 16px;
      font-weight: 600;
      color: #222;
      cursor: pointer;
      transition: border-color .2s;
    }
    select:hover { border-color: #999; }
    select:disabled { background-color: #f8f8f8; color: #888; }

    /* Linha ‚ÄúVoc√™ j√° enviou X artes...‚Äù (aparece s√≥ no Envio) */
    .envio-arts-info{
      max-width:900px;
      margin:10px auto 0;
      text-align:center;
      font-weight:800;
      font-size:14.5px;
      color:#222;
    }

    /* ===== Modal Telefone ===== */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:9999}
    .modal.show{display:grid}
    .modal-card{width:min(480px,92vw);background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .modal-card h3{margin:0 0 10px;text-align:center}
    .input-tel{width:100%;padding:12px;border:1px solid #cfd6e4;border-radius:10px;font-size:16px}
    .modal-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .modal-actions button{padding:10px 16px;border:none;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-primary{background:#e6b200;color:#111}
    .btn-neutral{background:#ddd;color:#111}
    .small-hint{font-size:12px;color:#666;text-align:center;margin-top:6px}
    .topbar-phone{font-weight:600;font-size:14px;margin-left:6px}
    .topbar-phone a{color:#000;text-decoration:underline;cursor:pointer}
  </style>
</head>
<body>
  <div class="topbar">[aluno]</div>

  <main class="page-center" style="--center-offset:-40px;">
    <img id="cursoLogo" class="curso-logo" alt="Curso" style="display:none">
    <div id="diasRestantes" class="dias-restantes">Carregando...</div>

    <!-- Cupom -->
    <div id="cupomBox" class="card" style="display:none">
      <div data-nome>{NOME}, seu acesso ao curso est√° acabando üò¢</div>
      <div style="margin-top:6px">
        Use o cupom <span id="cupomCod" style="background:#111;color:#ffd400;padding:3px 8px;border-radius:6px;font-weight:800">---</span>
        e receba <strong id="cupomPerc">---</strong>% de desconto para continuar.
        <a id="cupomLink" href="#" target="_blank" rel="noopener">Clique aqui</a>.
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard">
      <div class="box-feedback">
        <h3>Pr√≥ximo feedback:</h3>
        <p><strong id="fbDiaTxt" style="display:none"></strong><strong id="fbHoraTxt" style="display:none"></strong></p>
        <p>Professor: <strong id="fbProf">‚Äî</strong></p>
        <p><a id="fbLink" href="#" target="_blank" rel="noopener">[link da aula]</a></p>
        <p>Senha: <strong id="fbSenha">‚Äî</strong></p>
        <p id="fbInfo" style="margin-top:10px;color:#333"></p>
      </div>

      <button id="btnAbrirEnvio" class="btn-cta" type="button" data-busy>Envie os exerc√≠cios para feedback</button>

      <div class="card">
        <h3>√öltima aula gravada:</h3>
        <p class="hint">Aproveite para baixar pois ela expira.</p>
        <p><a id="ultimaGravada" href="#" target="_blank" rel="noopener">[link]</a></p>
      </div>

      <div class="links-uteis" style="text-align:center; margin-top:25px;">
        <strong>Links √∫teis:</strong><br>
        <a href="https://chat.whatsapp.com/JCnc5OfSkXVJyKB5uDQk81?mode=wwt"
          target="_blank"
          rel="noopener noreferrer"
          style="display:inline-block; margin-top:8px; color:#075e54; font-weight:600; text-decoration:none;">
          üí¨ Grupo dos alunos no WhatsApp
        </a>
      </div>
      <br>
      <div style="text-align:center"><button id="btnSair" class="btn-exit" type="button" data-busy>Sair</button></div>
      <p style="font-size:11px; text-align:center; color:#666; margin-top:0px;">
        <em data-nome>{NOME}, nunca compartilhe seu acesso com outras pessoas. Sua conta pode ser suspensa.</em>
      </p>
    </section>

    <!-- ENVIO -->
    <section id="envio" class="hidden">
      <!-- Linha com total de artes -->
      <p id="artsInfo" class="envio-arts-info hidden">
        Voc√™ j√° enviou <strong id="artsCount">0</strong> artes durante o curso!
      </p>

      <div class="card">
        <div id="limiteWrap" class="hidden" style="text-align:center; margin-bottom:16px;">
          <button class="btn-cta" type="button" disabled>
            ‚ùó Voc√™ j√° enviou o m√°ximo desta semana
          </button>
          <p style="margin-top:16px; font-size:16px; font-weight:600;">
            Semana que vem voc√™ poder√° enviar suas artes novamente para o feedback dos professores.
          </p>
          <p style="color:#888;">Enquanto isso, aproveite para estudar!</p>
        </div>

        <div id="envioFields">
          <h2>Envio de exerc√≠cio para feedback</h2>
          <div class="hint">Envie no m√°ximo 5 artes por semana.</div>

          <label>M√≥dulo:</label>
          <select id="selModulo" disabled><option>Carregando...</option></select>

          <label>Aula:</label>
          <select id="selAula" disabled><option>Selecione o m√≥dulo primeiro</option></select>

          <label>Envie a arte:</label>
          <div id="filesWrap" class="row">
            <input type="file" class="fileItem" accept="image/*">
            <div class="thumb-hint">Formatos JPG/PNG. At√© 3 envios.</div>
          </div>

          <div class="flex-row">
            <button id="btnAddImagem" class="btn-sec" type="button" data-busy>Adicionar imagem</button>
            <button id="btnResetar" class="btn-sec" type="button" data-busy>Cancelar imagens</button>
          </div>

          <label>Descri√ß√£o</label>
          <textarea id="descricao" rows="5" placeholder="Conte sobre suas dificuldades."></textarea>

          <button id="btnEnviar" class="btn-cta" type="button" data-busy>Enviar</button>
        </div>
      </div>

      <div class="envio-back" style="text-align:center;margin-top:10px;">
        <button id="btnVoltarEnvio" class="btn-back" type="button" data-busy>Voltar</button>
      </div>
    </section>

    <!-- SUCESSO -->
    <section id="sucesso" class="hidden">
      <div class="card">
        <h2>‚úÖ Enviado!</h2>
        <p>Seu desenho ser√° avaliado em breve.</p>
        <button id="btnVoltarMenu" class="btn-sec" type="button" data-busy>Voltar</button>
      </div>
    </section>
  </main>

  <!-- Modal Telefone -->
  <div id="phoneModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 data-nome>Oi {NOME}! Informe seu telefoneüìû</h3>
      <p style="text-align:center;margin:0 0 8px">Usaremos apenas para contato do curso e suporte se necess√°rio.</p>
      <input id="phoneInput" class="input-tel" placeholder="(11) 9 9999-9999" inputmode="numeric" autocomplete="tel">
      <div class="small-hint">Apenas n√∫meros (10 ou 11 d√≠gitos).</div>
      <div class="modal-actions">
        <button id="btnSalvarPhone" class="btn-primary" type="button">Salvar</button>
        <button id="btnCancelarPhone" class="btn-neutral" type="button">Cancelar</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-inner">
      <strong>Editora Cr√°s ‚Ä¢ </strong>
      <a href="mailto:contato@editoracras.com">Suporte</a>
      <small>¬© 2025. Todos os direitos reservados.</small>
    </div>
  </footer>

  <script>

   function renderNomeAluno(nome){
  document.querySelectorAll("[data-nome]").forEach(el => {
    if (!el.dataset.template) el.dataset.template = el.innerHTML;
    el.innerHTML = el.dataset.template.replaceAll("{NOME}", nome);
  });
}

    let tokensRestantes = 0;        // do bootstrap
    let artesTotal = 0;             // total vital√≠cio
    let telefone = "";              // telefone atual (s√≥ d√≠gitos)
    let primeiroLogin = false;      // flag da planilha
    const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";
    const MAX_FILES = 3;
    let sessao = null, bootstrap = null;

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    /* Helpers telefone */
    function onlyDigits(s){ return String(s||"").replace(/\D+/g,""); }
    function isValidBRPhone(d){ return /^\d{10,11}$/.test(d); }
    function formatBRPhone(d){
      const x = onlyDigits(d);
      if (x.length === 11) return `(${x.slice(0,2)}) ${x.slice(2,7)}-${x.slice(7)}`;
      if (x.length === 10) return `(${x.slice(0,2)}) ${x.slice(2,6)}-${x.slice(6)}`;
      return x;
    }

    /* Modal telefone */
    function showPhoneModal(){
      const m = qs("#phoneModal");
      const inp = qs("#phoneInput");
      inp.value = formatBRPhone(telefone||"");
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
      setTimeout(()=>inp.focus(), 50);
    }
    function hidePhoneModal(){
      const m = qs("#phoneModal");
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    }
    async function savePhone(){
      const raw = onlyDigits(qs("#phoneInput").value);
      if (!isValidBRPhone(raw)){
        alert("Digite um telefone v√°lido (10 ou 11 d√≠gitos).");
        return;
      }
      try{
        setLoading(true, "Salvando telefone‚Ä¶");
        const body = { action:"updatePhone", curso:sessao.curso, email:sessao.email, telefone: raw };
        const r = await fetch(API_URL, { method:"POST", body: JSON.stringify(body) });
        const d = await r.json();
        if (!d.ok) throw new Error(d.message || "Falha ao salvar telefone.");
        telefone = d.telefone;
        primeiroLogin = true;
        renderTopbarPhone();
        hidePhoneModal();
        alert("Telefone atualizado!");
      }catch(e){
        alert("Erro: " + e.message);
      }finally{
        setLoading(false);
      }
    }
    function renderTopbarPhone(){
      const tb = qs(".topbar");
      const old = tb.querySelector(".topbar-phone");
      if (old) old.remove();
      const span = document.createElement("span");
      span.className = "topbar-phone";
      const telText = telefone ? formatBRPhone(telefone) : "adicionar telefone";
      span.innerHTML = ` ‚Ä¢ üìû ${telText} <a id="linkEditarTel">(alterar)</a>`;
      tb.appendChild(span);
      qs("#linkEditarTel").onclick = (e)=>{ e.preventDefault(); showPhoneModal(); };
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try{ sessao = JSON.parse(localStorage.getItem("sessao_portal")||"null"); }catch{}
      const params = new URLSearchParams(location.search);
      if(!sessao) sessao = { email: params.get("email"), curso: params.get("curso") };
      if(!sessao || !sessao.email || !sessao.curso){ alert("Fa√ßa login novamente."); location.href="index.html"; return; }

      setLoading(true, "Carregando as informa√ß√µes...");
      await carregarBootstrap(sessao.curso, sessao.email);
      setLoading(false);

      qs("#btnAbrirEnvio").onclick = abrirEnvio;
      qs("#btnVoltarEnvio").onclick = () => { hide(qs("#envio")); show(qs("#dashboard")); window.scrollTo({top:0,behavior:"smooth"}); };
      qs("#btnAddImagem").onclick  = addFileInput;
      qs("#btnResetar").onclick    = resetFiles;
      qs("#btnEnviar").onclick     = enviarExercicio;
      qs("#btnVoltarMenu").onclick = () => { hide(qs("#sucesso")); show(qs("#dashboard")); };
      qs("#btnSair").onclick       = () => { localStorage.removeItem("sessao_portal"); location.href="index.html"; };

      // modal telefone
      qs("#btnSalvarPhone").onclick   = savePhone;
      qs("#btnCancelarPhone").onclick = hidePhoneModal;
      qs("#phoneInput").addEventListener("input", e => { e.target.value = formatBRPhone(e.target.value); });

      // Atualiza UI quando escolher arquivos
      qs("#filesWrap").addEventListener("change", () => updateUIForTokens());

      updateAddBtnVisibility();
    });

    async function carregarBootstrap(curso, email){
      try{
        const r = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(curso)}&email=${encodeURIComponent(email)}`);
        bootstrap = await r.json();
        if(!bootstrap || bootstrap.allowed !== true){ location.href = "index.html"; return; }

        // Topbar + logo
        qs(".topbar").textContent = `[${bootstrap.nome || "aluno"}]`;
renderNomeAluno(bootstrap.nome || "aluno");

        
        const logo = qs("#cursoLogo");
        if (bootstrap.logoUrl){ logo.src = bootstrap.logoUrl; logo.style.display = "block"; }

        // Telefone e flag de primeiro login
        telefone = String(bootstrap.telefone || "");
        primeiroLogin = !!bootstrap.primeiroLogin;
        renderTopbarPhone();

        // Dias restantes
        const dr = +bootstrap.diasRestantes || 0;
        qs("#diasRestantes").textContent = dr > 0
          ? (dr === 1 ? `[${dr}] dia restante de acesso ao curso.` : `[${dr}] dias restantes de acesso ao curso.`)
          : "Acesso expirado.";

        // Cupom (<= 30 dias)
        if (dr <= 30 && bootstrap.desconto?.cupom){
          qs("#cupomBox").style.display = "block";
          qs("#cupomCod").textContent = bootstrap.desconto.cupom;
          qs("#cupomPerc").textContent = bootstrap.desconto.porcentagem;
          qs("#cupomLink").href = bootstrap.desconto.link;
        }

        // Pr√≥ximo feedback / aula gravada
        const fb = bootstrap.feedback || {};
        if (fb.dia){ qs("#fbDiaTxt").textContent = fb.dia; qs("#fbDiaTxt").style.display = "block"; }
        if (fb.hora){ qs("#fbHoraTxt").textContent = fb.hora; qs("#fbHoraTxt").style.display = "block"; }
        qs("#fbProf").textContent  = bootstrap.feedback?.professor || "‚Äî";
        qs("#fbSenha").textContent = fb.senha || "‚Äî";
        qs("#fbInfo").textContent  = fb.info  || "‚Äî";
        if (fb.link){ qs("#fbLink").href = fb.link; qs("#fbLink").textContent = fb.link; }
        if (fb.aulaGravada){ qs("#ultimaGravada").href = fb.aulaGravada; qs("#ultimaGravada").textContent = fb.aulaGravada; }

        // TOKENS e artes
        tokensRestantes = Number(bootstrap.tokensRestantes ?? 0);
        artesTotal = Number(bootstrap.artesTotal || 0);

        // Se primeiro login/sem telefone, pedir agora
        if (!primeiroLogin || !telefone){
          setTimeout(showPhoneModal, 300);
        }

        updateUIForTokens();
      }catch(e){
        alert("Erro ao carregar.");
        location.href = "index.html";
      }
    }

    async function abrirEnvio(){
      setLoading(true, "Carregando envio‚Ä¶");
      hide(qs("#dashboard"));

      // limpar campos
      resetFiles();
      qs("#descricao").value = "";

      // mostrar linha de artes
      const info = qs("#artsInfo");
      const count = qs("#artsCount");
      if (artesTotal > 0){ count.textContent = artesTotal; show(info); }
      else { hide(info); }

      await carregarModulos();
      show(qs("#envio"));
      window.scrollTo({top:0,behavior:"smooth"});
      setLoading(false);

      updateUIForTokens();
    }

    async function carregarModulos(){
      const sel=qs("#selModulo"),selA=qs("#selAula");
      sel.disabled=true;sel.innerHTML="<option>Carregando...</option>";
      selA.disabled=true;selA.innerHTML="<option>Selecione o m√≥dulo primeiro</option>";
      try{
        const r=await fetch(`${API_URL}?action=listModules&curso=${encodeURIComponent(sessao.curso)}`);
        const d=await r.json(); const mods=Array.isArray(d.modulos)?d.modulos:[];
        sel.innerHTML="<option value=''>Selecione o m√≥dulo</option>";
        mods.forEach(m=>{const o=document.createElement("option");o.value=m;o.textContent=m;sel.appendChild(o);});
        sel.disabled=false; sel.onchange=carregarAulas;
      }catch{sel.innerHTML="<option>Erro ao carregar m√≥dulos</option>";}
    }

    async function carregarAulas(){
      const modulo=qs("#selModulo").value,sel=qs("#selAula");
      if(!modulo){sel.innerHTML="<option>Selecione o m√≥dulo primeiro</option>";return;}
      sel.innerHTML="<option>Carregando aulas...</option>";
      try{
        const r=await fetch(`${API_URL}?action=listLessons&curso=${encodeURIComponent(sessao.curso)}&modulo=${encodeURIComponent(modulo)}`);
        const d=await r.json(); const aulas=Array.isArray(d.aulas)?d.aulas:[];
        sel.innerHTML="<option value=''>Selecione a aula</option>";
        aulas.forEach(a=>{const o=document.createElement("option");o.value=a;o.textContent=a;sel.appendChild(o);});
        sel.disabled=false;
      }catch{sel.innerHTML="<option>Erro ao carregar aulas</option>";}
    }

    /* ======== UX / TOKENS ======== */
    function countSelectedFiles(){
      return qsa("#filesWrap input[type='file']").map(i => i.files[0]).filter(Boolean).length;
    }

    function updateUIForTokens(){
      const btnEnviar  = qs("#btnEnviar");
      const btnAdd     = qs("#btnAddImagem");
      const btnReset   = qs("#btnResetar");
      const wrapForm   = qs("#envioFields");
      const wrapLimit  = qs("#limiteWrap");

      const selected   = qsa("#filesWrap input[type='file']").map(i => i.files[0]).filter(Boolean).length;
      const inputsQtd  = qsa("#filesWrap input[type='file']").length;

      if (tokensRestantes <= 0){
        if (wrapForm)  wrapForm.style.display = "none";
        if (wrapLimit) wrapLimit.classList.remove("hidden");
        if (btnEnviar){
          btnEnviar.disabled = false;
          btnEnviar.textContent = "‚ùó Voc√™ j√° enviou o m√°ximo desta semana";
          btnEnviar.style.opacity = "0.9";
        }
        if (btnAdd)   btnAdd.style.display   = "none";
        if (btnReset) btnReset.style.display = "none";
        return;
      }

      if (wrapForm)  wrapForm.style.display = "block";
      if (wrapLimit) wrapLimit.classList.add("hidden");

      if (btnEnviar){
        btnEnviar.disabled = false;
        btnEnviar.textContent = "Enviar";
        btnEnviar.style.opacity = "";
      }

      const deveMostrarAdd = (
        tokensRestantes > 1 &&
        selected < tokensRestantes &&
        inputsQtd < MAX_FILES
      );
      if (btnAdd)   btnAdd.style.display   = deveMostrarAdd ? "inline-block" : "none";
      if (btnReset) btnReset.style.display = "inline-block";
    }

    function resetFiles(){
      qs("#filesWrap").innerHTML =
        '<input type="file" class="fileItem" accept="image/*">' +
        '<div class="thumb-hint">Formatos JPG/PNG. At√© 3 envios.</div>';
      updateUIForTokens();
    }

    function addFileInput(){
      if (tokensRestantes <= 0){ return; }
      const wrap         = qs("#filesWrap");
      const inputs       = qsa("#filesWrap input[type='file']");
      const inputsQtd    = inputs.length;
      const selectedNow  = inputs.map(i => i.files[0]).filter(Boolean).length;

      if (inputsQtd >= MAX_FILES) return;
      if (tokensRestantes <= 1)   return;
      if (selectedNow >= tokensRestantes) return;

      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "image/*";
      inp.className = "fileItem";
      wrap.insertBefore(inp, wrap.lastElementChild);

      updateUIForTokens();
    }

    function updateAddBtnVisibility(){
      updateUIForTokens();
    }

    /* ======== Envio ======== */
    async function enviarExercicio(){
      const modulo = qs("#selModulo").value.trim(),
            aula   = qs("#selAula").value.trim(),
            desc   = qs("#descricao").value.trim();

      if(!modulo) return alert("Selecione o m√≥dulo.");
      if(!aula)   return alert("Selecione a aula.");

      if (tokensRestantes <= 0){
        alert("Semana que vem voc√™ conseguir√° enviar novamente. Aproveite esse tempo para estudar o feedback que te foi passado.");
        return;
      }

      const chosen = qsa("#filesWrap input[type='file']")
                      .map(i => i.files[0])
                      .filter(Boolean);

      if(!chosen.length) return alert("Envie pelo menos uma imagem.");
      if(chosen.length > MAX_FILES) return alert(`M√°ximo de ${MAX_FILES} imagens.`);

      if(chosen.length > tokensRestantes){
        const resto = tokensRestantes;
        alert(resto > 0
          ? `Voc√™ s√≥ tem ${resto} envio(s) restante(s) nesta semana.`
          : "Semana que vem voc√™ conseguir√° enviar novamente. Aproveite esse tempo para estudar o feedback que te foi passado.");
        return;
      }

      setLoading(true, "Enviando seu desenho‚Ä¶");

      try{
        const files=[];
        for(const f of chosen){
          const base64 = await new Promise((res, rej)=>{
            const fr = new FileReader();
            fr.onload  = () => res(fr.result.split(",")[1]);
            fr.onerror = () => rej();
            fr.readAsDataURL(f);
          });
          files.push({name:f.name,type:f.type,content:base64});
        }

        const body = {
          action:"uploadExercise",
          curso:sessao.curso,
          email:sessao.email,
          nome:bootstrap.nome,
          modulo,
          aula,
          descricao:desc,
          files
        };

        const r = await fetch(API_URL,{method:"POST",body:JSON.stringify(body)});
        const d = await r.json();

        if(!d.ok){
          if (d.message === "limit_exceeded"){
            alert("Semana que vem voc√™ conseguir√° enviar novamente. Aproveite esse tempo para estudar o feedback que te foi passado.");
            return;
          }
          throw new Error(d.message || "Falha");
        }

        if(typeof d.tokensRestantes === "number"){
          tokensRestantes = d.tokensRestantes;
        }

        resetFiles();
        hide(qs("#envio"));
        show(qs("#sucesso"));
        updateUIForTokens();

      }catch(e){
        alert("Erro: " + e.message);
      }finally{
        setLoading(false);
      }
    }
  </script>

  <!-- Overlay global -->
  <script>
    function setLoading(state, msg = "Carregando‚Ä¶") {
      const box = document.getElementById("global-loading");
      const bubble = box ? box.querySelector(".global-loading-bubble") : null;
      if (bubble) bubble.textContent = msg;
      document.querySelectorAll("[data-busy]").forEach(el => el.disabled = !!state);
      if (box) box.style.display = state ? "grid" : "none";
    }
  </script>

  <div id="global-loading" aria-live="polite" aria-busy="true" style="display:none">
    <div class="global-loading-bubble">Carregando‚Ä¶</div>
  </div>
</body>
</html>




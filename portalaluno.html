<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Portal do Aluno â€“ Editora CrÃ¡s</title>
  <meta name="description" content="Acompanhe o prÃ³ximo feedback, envie exercÃ­cios e acesse conteÃºdos gravados.">
  <link rel="stylesheet" href="style.css?v=5">

  <style>
    .topbar{
      width:100vw;margin-left:calc(50% - 50vw);margin-right:calc(50% - 50vw);
      background:#e6b200;color:#000;font-weight:800;text-align:center;
      padding:12px 0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
    }
    .curso-logo{width:200px;max-width:60vw;height:auto;display:block;margin:10px auto 6px}
    .dias-restantes{font-weight:800;margin:8px 0 6px;text-align:center}
    .dias-danger{color:#d93025}

    .card,.box-feedback{
      max-width:900px;margin:14px auto;background:#fff;
      border:1px solid #f2e3a6;border-radius:18px;padding:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.06);text-align:center;
    }
    .btn-cta{
      display:block;width:100%;max-width:900px;margin:16px auto;
      padding:16px 18px;border:none;border-radius:18px;
      background:#e6b200;color:#111;font-weight:800;cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
    }
    .btn-cta:disabled{opacity:.6;cursor:not-allowed}
    .btn-exit{
      display:inline-block;margin:18px auto 40px;padding:10px 18px;
      background:#e53935;color:#fff;border:none;border-radius:12px;
      font-weight:800;cursor:pointer;
    }
    .links-uteis{text-align:center;font-weight:800;margin-top:30px}
    #overlay{display:none;position:fixed;inset:0;width:100svw;height:100svh;
      background:rgba(255,255,255,.85);z-index:9999;place-items:center}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="topbar">[aluno]</div>

  <main class="page-center" style="--center-offset:-40px;">
    <img id="cursoLogo" class="curso-logo" alt="Curso" style="display:none">

    <div id="diasRestantes" class="dias-restantes">Carregando...</div>

    <div id="cupomBox" class="card hidden">
      <div>Poxa, seu acesso ao curso estÃ¡ acabando ðŸ˜¢</div>
      <div style="margin-top:6px">
        Use o cupom <span id="cupomCod" style="background:#111;color:#ffd400;padding:3px 8px;border-radius:6px;font-weight:800">---</span>
        e receba <strong id="cupomPerc">---</strong>% de desconto para adquirir novamente.
        <a id="cupomLink" href="#" target="_blank" rel="noopener">Clique aqui</a>.
      </div>
    </div>

    <section id="dashboard">
      <!-- CartÃ£o: PrÃ³ximo feedback -->
      <div class="box-feedback">
        <h3>PrÃ³ximo feedback:</h3>
        <p><strong id="fbDia">â€”</strong></p>
        <p><strong id="fbHora">â€”</strong></p>
        <p>Professor: <strong id="fbProf">â€”</strong></p>
        <p><a id="fbLink" href="#" target="_blank" rel="noopener">[link da aula]</a></p>
        <p>Senha: <strong id="fbSenha">â€”</strong></p>
        <p id="fbInfo" style="margin-top:10px;color:#333">â€”</p>
      </div>

      <!-- BotÃ£o Envie -->
      <button id="btnAbrirEnvio" class="btn-cta" type="button" onclick="abrirEnvio()">
        Envie os exercÃ­cios para feedback
      </button>

      <!-- CartÃ£o: Aula gravada -->
      <div class="card">
        <h3>Ãšltima aula gravada:</h3>
        <p>Aproveite para baixar pois ela expira.</p>
        <p><a id="ultimaGravada" href="#" target="_blank" rel="noopener">[link]</a></p>
      </div>

      <div class="links-uteis">Links Ãºteis</div>
      <div style="text-align:center">
        <button id="btnSair" class="btn-exit">sair</button>
      </div>
    </section>

    <section id="envio" class="hidden">
      <div class="card">
        <h2>Envio de exercÃ­cio</h2>
        <p>*No mÃ¡ximo 3 artes por semana. Envie apenas no dia do feedback.</p>
        <select id="selModulo" class="input-like" disabled>
          <option>Carregando mÃ³dulos...</option>
        </select>
        <select id="selAula" class="input-like" disabled>
          <option>Selecione o mÃ³dulo</option>
        </select>
        <input type="file" id="file1" accept="image/*">
        <textarea id="descricao" placeholder="Comente sobre seu desenho"></textarea>
        <button id="btnEnviar" class="btn-cta">Enviar</button>
      </div>
    </section>

    <section id="sucesso" class="hidden">
      <div class="card">
        <h2>âœ… Enviado!</h2>
        <p>Seu desenho foi enviado para avaliaÃ§Ã£o.</p>
        <button id="btnVoltarMenu" class="btn-cta" style="max-width:320px">Voltar</button>
      </div>
    </section>
  </main>

  <div id="overlay"><div class="loader-text">Processandoâ€¦</div></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";
    let sessao=null, bootstrap=null;

    const qs=s=>document.querySelector(s);
    const show=el=>el.classList.remove("hidden");
    const hide=el=>el.classList.add("hidden");

    document.addEventListener("DOMContentLoaded",async()=>{
      try{sessao=JSON.parse(localStorage.getItem("sessao_portal")||"null");}catch{}
      const p=new URLSearchParams(location.search);
      if(!sessao)sessao={email:p.get("email"),curso:p.get("curso")};
      if(!sessao||!/^[^@]+@[^@]+\.[^@]+$/.test(sessao.email)||!sessao.curso){
        alert("FaÃ§a login novamente.");location.href="index.html";return;
      }
      await carregarBootstrap(sessao.curso,sessao.email);
      qs("#btnSair").onclick=()=>{localStorage.removeItem("sessao_portal");location.href="index.html"};
      qs("#btnVoltarMenu").onclick=()=>{hide(qs("#sucesso"));show(qs("#dashboard"));};
    });

    async function carregarBootstrap(curso,email){
      const resp=await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(curso)}&email=${encodeURIComponent(email)}`);
      bootstrap=await resp.json();
      if(!bootstrap.allowed)return location.href="index.html";
      qs(".topbar").textContent=`[${bootstrap.nome}]`;
      if(bootstrap.logoUrl){qs("#cursoLogo").src=bootstrap.logoUrl;qs("#cursoLogo").style.display="block";}
      const dr=Number(bootstrap.diasRestantes||0);
      qs("#diasRestantes").textContent=`[${dr}] dias restantes de acesso ao curso`;
      if(dr<=30){
        qs("#diasRestantes").classList.add("dias-danger");
        const c=bootstrap.desconto;if(c&&c.cupom){
          qs("#cupomCod").textContent=c.cupom;
          qs("#cupomPerc").textContent=(c.porcentagem||"").replace(/%/g,"");
          qs("#cupomLink").href=c.link||"#";
          show(qs("#cupomBox"));
        }
      }

      const fb=bootstrap.feedback||{};
      qs("#fbDia").textContent=fb.dia||"â€”";
      qs("#fbHora").textContent=fb.hora||"â€”";
      qs("#fbProf").textContent=bootstrap.professorNome||"â€”";
      qs("#fbSenha").textContent=fb.senha||"â€”";
      qs("#fbInfo").textContent=fb.info||"â€”";

      const link=fb.link||"";
      const linkEl=qs("#fbLink");
      const valid=/^https?:\/\//i.test(link)?link:`https://${link}`;
      linkEl.href=valid;linkEl.textContent=link||"â€”";

      const ag=fb.aulaGravada||"";
      const grav=qs("#ultimaGravada");
      const gravLink=/^https?:\/\//i.test(ag)?ag:`https://${ag}`;
      grav.href=gravLink;grav.textContent=ag||"â€”";
    }

    async function abrirEnvio(){
      hide(qs("#dashboard"));show(qs("#envio"));
      window.scrollTo({top:0,behavior:"smooth"});
    }
  </script>
</body>
</html>

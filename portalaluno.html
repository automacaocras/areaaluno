<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Portal do Aluno – Editora Crás</title>
<link rel="stylesheet" href="style.css?v=7">
<style>
  .disabled-btn {
    background:#ccc!important;
    color:#666!important;
    cursor:not-allowed!important;
  }
</style>
</head>
<body>
<div class="topbar">[aluno]</div>

<main class="page-center" style="--center-offset:-40px;">
  <img id="cursoLogo" class="curso-logo" style="display:none">
  <div id="diasRestantes" class="dias-restantes">Carregando…</div>

  <section id="dashboard">
    <div class="box-feedback" id="feedbackBox">
      <h3>Próximo feedback:</h3>
      <p id="fbResumo"></p>
      <p id="fbExtra"></p>
    </div>

    <!-- ✅ botão será bloqueado fora da janela -->
    <button id="btnAbrirEnvio" class="btn-cta" type="button">Enviar exercícios</button>

    <div id="gravadaCard" class="card" style="display:none">
      <h3>Última aula gravada:</h3>
      <p><a id="ultimaGravada" href="#" target="_blank" rel="noopener">[link]</a></p>
    </div>

    <div style="text-align:center;margin-top:20px">
      <button id="btnSair" class="btn-exit" type="button">Sair</button>
    </div>
  </section>

  <!-- envio e sucesso omitidos (mantêm seu HTML atual) -->
</main>

<div id="global-loading" style="display:none;position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);z-index:9999;">
  <div class="global-loading-bubble" style="background:#fff;padding:16px 22px;border-radius:12px;font-weight:700;">Carregando…</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";
let sessao=null, bootstrap=null;

document.addEventListener("DOMContentLoaded", async()=>{
  try{ sessao = JSON.parse(localStorage.getItem("sessao_portal")||"null"); }catch{}
  if(!sessao||!sessao.email||!sessao.curso){ alert("Faça login."); location.replace("index.html"); return; }

  setLoading(true,"Carregando…");
  const r = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(sessao.curso)}&email=${encodeURIComponent(sessao.email)}`);
  bootstrap = await r.json();
  setLoading(false);
  if(!bootstrap||bootstrap.allowed!==true){ alert("Acesso inválido"); location.replace("index.html"); return; }

  renderFeedback(bootstrap.liveState||bootstrap.feedback||{});
  renderGravada(bootstrap.feedback||{});

  document.getElementById("btnSair").onclick=()=>{localStorage.removeItem("sessao_portal");location.replace("index.html");};
  document.getElementById("btnAbrirEnvio").onclick=abrirEnvio;
});

// ✅ mostra live/estado
function renderFeedback(fb){
  const box=document.getElementById("feedbackBox");
  const resumo=document.getElementById("fbResumo");
  const extra=document.getElementById("fbExtra");
  resumo.textContent="";
  extra.textContent="";
  const cleared = fb.cleared===true;
  const canSubmit = fb.canSubmit===true;
  const link = fb.link||"";
  const hora = fb.hora||"";
  const dia  = fb.dia||"";
  const prof = fb.professor||"";
  const info = fb.info||"";
  if(cleared){
    resumo.innerHTML="Aguarde a próxima data.";
    document.getElementById("btnAbrirEnvio").classList.add("disabled-btn");
    document.getElementById("btnAbrirEnvio").disabled=true;
    return;
  }
  let t = "";
  if(dia) t+=dia;
  if(hora) t+= (t?", ":"")+hora;
  if(prof) t+= (t?" com ":"Com ")+prof;
  resumo.innerHTML=t||"—";
  extra.innerHTML=info||"";
  const btn=document.getElementById("btnAbrirEnvio");
  if(canSubmit){
    btn.classList.remove("disabled-btn");
    btn.disabled=false;
  }else{
    btn.classList.add("disabled-btn");
    btn.disabled=true;
    btn.textContent="Envio encerrado. Aguarde próxima aula.";
  }
}

function renderGravada(fb){
  const url=(fb.aulaGravada||"").trim();
  const card=document.getElementById("gravadaCard");
  if(url){ card.style.display="block"; document.getElementById("ultimaGravada").href=url; document.getElementById("ultimaGravada").textContent=url;}
  else card.style.display="none";
}

// ✅ botão abre envio só se permitido
function abrirEnvio(){
  if(document.getElementById("btnAbrirEnvio").disabled){
    alert("Envio ainda não liberado ou já encerrado. Aguarde a próxima aula.");
    return;
  }
  // mostrar seção de envio normal (mantém seu código atual)
  alert("Aqui abriria o formulário de envio.");
}

function setLoading(state,msg="Carregando…"){
  const box=document.getElementById("global-loading");
  if(!box)return;
  box.style.display=state?"grid":"none";
  if(state) box.querySelector(".global-loading-bubble").textContent=msg;
}
</script>
</body>
</html>

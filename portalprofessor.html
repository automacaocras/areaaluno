<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Portal do Professor – Editora Crás</title>
  <meta name="description" content="Atualizar link da aula e limpar exercícios dos alunos.">
  <link rel="icon" type="image/png" href="Assets/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="Assets/apple-touch-icon.png" sizes="180x180">
  <link rel="shortcut icon" href="Assets/favicon.ico">
  <meta name="theme-color" content="#0286ff">
  <link rel="stylesheet" href="style.css?v=3">

  <style>
    /* topbar full-bleed */
    .topbar{
      width:100vw;
      margin-left:calc(50% - 50vw);
      margin-right:calc(50% - 50vw);
      background:#f4c200;color:#000;font-weight:800;text-align:center;
      padding:14px 0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
    }

    .wrap{max-width:900px;margin:20px auto;}

    /* faixa para deixar os botões com a MESMA largura do box branco */
    .band{max-width:900px;margin:12px auto;display:flex;flex-direction:column;gap:12px}
    .btn-band{display:block;width:100%;padding:16px 18px;border:none;border-radius:12px;
      font-weight:800;cursor:pointer;text-align:center;color:#fff}
    .btn-live{background:#ff6b6b}
    .btn-grav{background:#ff9f45}

    .panel{background:#fff;border:1px solid #f2e3a6;border-radius:18px;padding:18px;
      box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .panel h3{margin:0 0 10px;text-align:center}

    .links-box a{display:block;word-break:break-all;margin:8px 0;padding:10px 12px;
      background:#f7f7ff;border-radius:10px;text-decoration:underline;color:#1d2433;text-align:center}

    /* forms mais largos */
    .field{margin:10px auto;max-width:720px}
    .field input,.field textarea{width:100%;padding:12px;border:1px solid #cfd6e4;border-radius:10px;background:#fff;font-size:16px}
    .field textarea{min-height:110px}

    .btn-primary{display:block;width:100%;max-width:420px;margin:18px auto 6px;padding:14px 18px;
      border:none;border-radius:12px;background:#f4c200;color:#111;font-weight:800;cursor:pointer}
    .btn-neutral{display:block;width:100%;max-width:320px;margin:10px auto;padding:12px 18px;
      border:none;border-radius:12px;background:#ddd;color:#111;font-weight:800;cursor:pointer}

    .btn-exit{display:block;width:140px;margin:18px auto 0;padding:12px 18px;border:none;
      border-radius:12px;background:#d64545;color:#fff;font-weight:800;cursor:pointer}

    .hidden{display:none !important}

    #overlay{display:none;position:fixed;inset:0;width:100svw;height:100svh;background:rgba(255,255,255,.85);z-index:9999;place-items:center}
    #overlay .loader-text{font-size:18px;color:#111}
  </style>
</head>
<body>
  <div class="topbar" id="topbar">[professor]</div>

  <main class="page-center" style="--center-offset:-40px;">
    <div class="wrap">

      <!-- HOME (botões + links úteis + sair) -->
      <section id="home">

        <h2 style="text-align:center;margin:8px 0 6px">Área do professor</h2>

        <div class="band">
          <button class="btn-band btn-live" id="btnAbrirLive">Atualizar próxima aula ao vivo</button>
          <button class="btn-band btn-grav" id="btnAbrirGrav">Atualizar link da aula gravada</button>
        </div>

        <section class="panel" id="linksPanel">
          <h3>Links úteis:</h3>
          <div class="links-box">
            <a id="lnkPlanilhaExercicios" href="#" target="_blank" rel="noopener">—</a>
            <a id="lnkDriveExercicios"   href="#" target="_blank" rel="noopener">—</a>
          </div>
        </section>

        <button id="btnSair" class="btn-exit">Sair</button>
      </section>

      <!-- FORM: Próxima aula ao vivo -->
      <section id="formLive" class="panel hidden">
        <h3>Próxima aula ao vivo</h3>
        <div class="field"><input   id="fLink"  placeholder="Link"></div>
        <div class="field"><input   id="fSenha" placeholder="Senha"></div>
        <div class="field"><input   id="fHora"  placeholder="Hora (ex.: 20:00)"></div>
        <div class="field"><input   id="fDia"   placeholder="Dia (ex.: quinta-feira)"></div>
        <div class="field"><textarea id="fInfo"  placeholder="Info"></textarea></div>

        <button id="btnEnviarLive" class="btn-primary">Atualizar</button>
        <button id="btnVoltar1" class="btn-neutral" type="button">Voltar</button>
      </section>

      <!-- FORM: Aula gravada -->
      <section id="formGrav" class="panel hidden">
        <h3>Atualizar link da aula gravada</h3>
        <div class="field"><input id="fGravada" placeholder="Link da aula gravada"></div>

        <button id="btnEnviarGrav" class="btn-primary">Atualizar</button>
        <button id="btnVoltar2" class="btn-neutral" type="button">Voltar</button>
      </section>

    </div>
  </main>

  <div id="overlay"><div class="loader-text">Processando…</div></div>

  <footer class="site-footer">
    <div class="footer-inner">
      <strong>Editora Crás • </strong>
      <a href="mailto:contato@editoracras.com">Suporte</a>
      <small>© 2025. Todos os direitos reservados.</small>
    </div>
  </footer>

  <script>
    // mesmo endpoint do aluno
    const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";

    const qs  = s => document.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    let sessao = null, bootstrap = null;

    function setLoading(b){
      qs('#overlay').style.display = b ? 'grid' : 'none';
      ['#btnEnviarLive','#btnEnviarGrav'].forEach(id => { const el = qs(id); if (el) el.disabled = b; });
    }
    function getParams(){
      const p = new URLSearchParams(location.search);
      return { curso: p.get('curso') || '', email: p.get('email') || '' };
    }
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    document.addEventListener('DOMContentLoaded', boot);

    async function boot(){
      try { sessao = JSON.parse(localStorage.getItem('sessao_portal') || 'null'); } catch {}
      const params = getParams();
      if (!sessao) sessao = { email: params.email, curso: params.curso };

      if (!sessao || !validEmail(sessao.email) || !sessao.curso) {
        alert('Faça login novamente.'); location.href='index.html'; return;
      }

      const resp = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(sessao.curso)}&email=${encodeURIComponent(sessao.email)}`, {cache:'no-store'});
      bootstrap = await resp.json();

      if (!bootstrap || bootstrap.allowed !== true || String(bootstrap.perfil).toLowerCase() !== 'professor') {
        alert('Acesso de professor não validado. Faça login novamente.');
        location.href='index.html'; return;
      }

      qs('#topbar').textContent = `[${bootstrap.nome || 'professor'}]`;

      // links úteis
      const planUrl  = bootstrap?.profLinks?.exerciciosSheetUrl || '#';
      const driveHub = bootstrap?.profLinks?.driveHubUrl || '#';
      qs('#lnkPlanilhaExercicios').textContent = planUrl;  qs('#lnkPlanilhaExercicios').href = planUrl;
      qs('#lnkDriveExercicios').textContent    = driveHub; qs('#lnkDriveExercicios').href    = driveHub;

      // navegação
      qs('#btnAbrirLive').addEventListener('click', () => { hide(qs('#home')); show(qs('#formLive')); window.scrollTo({top:0,behavior:'smooth'}); });
      qs('#btnAbrirGrav').addEventListener('click', () => { hide(qs('#home')); show(qs('#formGrav')); window.scrollTo({top:0,behavior:'smooth'}); });
      qs('#btnVoltar1').addEventListener('click', goHome);
      qs('#btnVoltar2').addEventListener('click', goHome);
      qs('#btnSair').addEventListener('click', () => { localStorage.removeItem('sessao_portal'); location.href='index.html'; });

      // ações
      qs('#btnEnviarLive').addEventListener('click', enviarLive);
      qs('#btnEnviarGrav').addEventListener('click', enviarGrav);
    }

    function clearForms(){
      ['#fLink','#fSenha','#fHora','#fDia','#fInfo','#fGravada'].forEach(sel=>{
        const el = qs(sel); if (el) el.value = '';
      });
    }

    function goHome(){
      // volta para a Home
      hide(qs('#formLive')); hide(qs('#formGrav'));
      show(qs('#home'));
      // limpa campos (opcional)
      clearForms();
      // evita que o Voltar do navegador retorne ao form
      history.replaceState({}, "", location.pathname + location.search);
      window.scrollTo({top:0,behavior:'smooth'});
    }

    async function enviarLive(){
      const body = {
        action: 'updateFeedbackLive',
        curso: sessao.curso,
        email: sessao.email,
        link:  qs('#fLink').value.trim(),
        senha: qs('#fSenha').value.trim(),
        hora:  qs('#fHora').value.trim(),
        dia:   qs('#fDia').value.trim(),
        info:  qs('#fInfo').value.trim()
      };
      setLoading(true);
      try{
        const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(body) });
        const data = await r.json();
        if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

        // volta imediatamente para o início
        goHome();
        // mostra confirmação logo depois
        setTimeout(()=>alert('Próxima aula ao vivo atualizada!'), 50);
      }catch(e){
        alert('Erro ao atualizar: ' + e.message);
      }finally{
        setLoading(false);
      }
    }

    async function enviarGrav(){
      const body = {
        action: 'updateGravada',
        curso: sessao.curso,
        email: sessao.email,
        aulaGravada: qs('#fGravada').value.trim()
      };
      setLoading(true);
      try{
        const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify(body) });
        const data = await r.json();
        if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

        // volta imediatamente para o início
        goHome();
        // mostra confirmação logo depois
        setTimeout(()=>alert('Link da aula gravada atualizado!'), 50);
      }catch(e){
        alert('Erro ao atualizar: ' + e.message);
      }finally{
        setLoading(false);
      }
    }
  </script>

  <script>
  // Controle único do overlay + trava/destrava de botões marcados
  function setLoading(state, msg = "Carregando…") {
    const box = document.getElementById("global-loading");
    const bubble = box ? box.querySelector(".global-loading-bubble") : null;
    if (bubble) bubble.textContent = msg;

    // (Opcional) desabilita/rehabilita todos elementos com [data-busy]
    document.querySelectorAll("[data-busy]").forEach(el => el.disabled = !!state);

    if (box) box.style.display = state ? "grid" : "none";
  }
</script>

  
  <!-- Overlay global -->
<div id="global-loading" aria-live="polite" aria-busy="true" style="display:none">
  <div class="global-loading-bubble">Carregando…</div>
</div>

</body>
</html>



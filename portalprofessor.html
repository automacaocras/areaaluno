<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Portal do Professor – Editora Crás</title>
  <meta name="description" content="Atualizar link da aula e limpar exercícios dos alunos.">
  <link rel="icon" type="image/png" href="Assets/favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="Assets/apple-touch-icon.png" sizes="180x180">
  <link rel="shortcut icon" href="Assets/favicon.ico">
  <meta name="theme-color" content="#0286ff">
  <link rel="stylesheet" href="style.css?v=3">

  <style>
    /* Topbar full-bleed */
    .topbar{
      width:100vw;
      margin-left:calc(50% - 50vw);
      margin-right:calc(50% - 50vw);
      background:#f4c200;color:#000;font-weight:800;text-align:center;
      padding:14px 0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08);
    }

    .wrap{max-width:900px;margin:20px auto;}
    .panel{background:#fff;border:1px solid #f2e3a6;border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);}
    .panel h3{margin:0 0 10px;text-align:center;}
    .hidden{display:none !important;}

    /* Botões e campos */
    .btn-hero{display:block;width:100%;max-width:520px;margin:14px auto;padding:14px 18px;border:none;border-radius:12px;background:#ff6767;color:#fff;font-weight:800;cursor:pointer;}
    .btn-hero.secondary{background:#ffa24f;color:#fff;}
    .btn-submit{display:block;width:100%;max-width:420px;margin:18px auto 6px;padding:14px 18px;border:none;border-radius:12px;background:#f4c200;color:#111;font-weight:800;cursor:pointer;}
    .btn-neutral{display:block;width:100%;max-width:260px;margin:14px auto;padding:12px 18px;border:none;border-radius:12px;background:#ddd;color:#111;font-weight:800;cursor:pointer;}

    .links-box a{display:block;word-break:break-all;margin:8px 0;padding:10px 12px;background:#f7f7ff;border-radius:10px;text-decoration:underline;color:#1d2433;text-align:center;}

    .field{margin:10px auto;max-width:520px;}
    .field input,.field textarea{width:100%;padding:12px;border:1px solid #cfd6e4;border-radius:10px;background:#fff;font-size:16px;}
    .field textarea{min-height:90px;}

    /* Título “área do professor” fora do cartão branco */
    .prof-title{font-size:28px;font-weight:800;text-align:center;margin:4px 0 8px;}

    /* Overlay */
    #overlay{display:none;position:fixed;inset:0;width:100svw;height:100svh;background:rgba(255,255,255,.85);z-index:9999;place-items:center;}
    #overlay .loader-text{font-size:18px;color:#111;}
  </style>
</head>
<body>
  <div class="topbar" id="topbar">[professor]</div>

  <main class="page-center" style="--center-offset: -40px;">
    <div class="wrap">

      <!-- ======== HOME VIEW: título, botões e links úteis + sair ======== -->
      <div id="homeView">
        <div class="prof-title">área do professor</div>

        <button id="btnOpenLive" class="btn-hero">Atualizar próxima aula ao vivo</button>
        <button id="btnOpenRecorded" class="btn-hero secondary">Atualizar link da aula gravada</button>

        <section id="linksCard" class="panel" style="margin-top:16px;">
          <h3>Links úteis:</h3>
          <div class="links-box">
            <a id="lnkPlanilhaExercicios" href="#" target="_blank" rel="noopener">—</a>
            <a id="lnkDriveExercicios"   href="#" target="_blank" rel="noopener">—</a>
          </div>
        </section>

        <button id="btnSair" class="btn-neutral">sair</button>
      </div>

      <!-- ======== FORM: Próxima aula ao vivo ======== -->
      <section id="formLive" class="panel hidden">
        <h3>Próxima aula ao vivo</h3>
        <div class="field"><input   id="fLink"     placeholder="Link"></div>
        <div class="field"><input   id="fSenha"    placeholder="Senha"></div>
        <div class="field"><input   id="fHora"     placeholder="Hora (ex.: 20:00)"></div>
        <div class="field"><input   id="fDia"      placeholder="Dia (ex.: quinta-feira)"></div>
        <div class="field"><textarea id="fInfo"    placeholder="Info"></textarea></div>

        <button id="btnEnviarLive" class="btn-submit">Atualizar</button>
        <button class="btn-neutral" type="button" onclick="goHome()">Voltar</button>
      </section>

      <!-- ======== FORM: Aula gravada (só H) ======== -->
      <section id="formRecorded" class="panel hidden">
        <h3>Aula gravada</h3>
        <div class="field"><input id="fGravada" placeholder="Link da aula gravada"></div>

        <button id="btnEnviarRecorded" class="btn-submit">Atualizar</button>
        <button class="btn-neutral" type="button" onclick="goHome()">Voltar</button>
      </section>

    </div>
  </main>

  <!-- Overlay -->
  <div id="overlay"><div class="loader-text">Processando…</div></div>

  <footer class="site-footer">
    <div class="footer-inner">
      <strong>Editora Crás • </strong>
      <a href="mailto:contato@editoracras.com">Suporte</a>
      <small>© 2025. Todos os direitos reservados.</small>
    </div>
  </footer>

  <script>
    // Mesmo endpoint do aluno
    const API_URL = "https://script.google.com/macros/s/AKfycbwQ9utyV79uWjpVHuBRWbie_2kkgTX-lPBudob49WA2daqn5qdbdqyzhl3LqYC0y_fVuQ/exec";

    const qs  = s => document.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    let sessao = null;
    let bootstrap = null;

    function setLoading(b, which){
      qs('#overlay').style.display = b ? 'grid' : 'none';
      if (which === 'live') qs('#btnEnviarLive').disabled = b;
      if (which === 'rec')  qs('#btnEnviarRecorded').disabled = b;
    }

    function getParams(){
      const p = new URLSearchParams(location.search);
      return { curso: p.get('curso') || '', email: p.get('email') || '' };
    }
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    // Navegação entre visões
    function goHome(){
      hide(qs('#formLive'));
      hide(qs('#formRecorded'));
      show(qs('#homeView'));
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function openLive(){
      hide(qs('#homeView'));
      show(qs('#formLive'));
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function openRecorded(){
      hide(qs('#homeView'));
      show(qs('#formRecorded'));
      window.scrollTo({top:0,behavior:'smooth'});
    }

    document.addEventListener('DOMContentLoaded', boot);

    async function boot(){
      try { sessao = JSON.parse(localStorage.getItem('sessao_portal') || 'null'); } catch {}
      const params = getParams();
      if (!sessao) sessao = { email: params.email, curso: params.curso };

      if (!sessao || !validEmail(sessao.email) || !sessao.curso) {
        alert('Faça login novamente.'); location.href='index.html'; return;
      }

      // valida e carrega dados mínimos (links e nome)
      const resp = await fetch(`${API_URL}?action=portalBootstrap&curso=${encodeURIComponent(sessao.curso)}&email=${encodeURIComponent(sessao.email)}`, {cache:'no-store'});
      bootstrap = await resp.json();

      if (!bootstrap || bootstrap.allowed !== true || String(bootstrap.perfil).toLowerCase() !== 'professor') {
        alert('Acesso de professor não validado. Faça login novamente.');
        location.href = 'index.html'; return;
      }

      qs('#topbar').textContent = `[${bootstrap.nome || 'professor'}]`;

      // links úteis
      const planUrl  = bootstrap?.profLinks?.exerciciosSheetUrl || '#';
      const driveHub = bootstrap?.profLinks?.driveHubUrl || '#';
      qs('#lnkPlanilhaExercicios').textContent = planUrl;  qs('#lnkPlanilhaExercicios').href = planUrl;
      qs('#lnkDriveExercicios').textContent    = driveHub; qs('#lnkDriveExercicios').href    = driveHub;

      // ações
      qs('#btnOpenLive').addEventListener('click', openLive);
      qs('#btnOpenRecorded').addEventListener('click', openRecorded);
      qs('#btnSair').addEventListener('click', () => { localStorage.removeItem('sessao_portal'); location.href='index.html'; });

      // submits
      qs('#btnEnviarLive').addEventListener('click', enviarLive);
      qs('#btnEnviarRecorded').addEventListener('click', enviarRecorded);
    }

    async function enviarLive(){
      const body = {
        action: 'updateFeedback',
        curso: sessao.curso,
        email: sessao.email, // revalida prof
        // sem título (removido do formulário)
        link: qs('#fLink').value.trim(),
        senha: qs('#fSenha').value.trim(),
        hora: qs('#fHora').value.trim(),
        dia:  qs('#fDia').value.trim(),
        info: qs('#fInfo').value.trim()
      };

      setLoading(true, 'live');
      try{
        const r = await fetch(API_URL, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

        alert('Próxima aula ao vivo atualizada!');
        goHome();
      }catch(e){
        console.error(e);
        alert('Erro ao atualizar: ' + e.message);
      }finally{
        setLoading(false, 'live');
      }
    }

    async function enviarRecorded(){
      const body = {
        action: 'updateRecordedOnly',
        curso: sessao.curso,
        email: sessao.email,
        aulaGravada: qs('#fGravada').value.trim()
      };

      setLoading(true, 'rec');
      try{
        const r = await fetch(API_URL, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if (!data || data.ok !== true) throw new Error((data && (data.message || data.error)) || 'Falha ao atualizar');

        alert('Link da aula gravada atualizado!');
        goHome();
      }catch(e){
        console.error(e);
        alert('Erro ao atualizar: ' + e.message);
      }finally{
        setLoading(false, 'rec');
      }
    }
  </script>
</body>
</html>
